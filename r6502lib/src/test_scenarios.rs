#![cfg(test)]

use anyhow::Result;
use r6502validationlib::Scenario;
use rstest::rstest;

use crate::run_scenario;

#[rstest]
#[case(r#"{ "name": "61 1e 49", "initial": { "pc": 26086, "s": 108, "a": 250, "x": 117, "y": 104, "p": 173, "ram": [ [26086, 97], [26087, 30], [26088, 73], [30, 225], [147, 188], [148, 211], [54204, 79]]}, "final": { "pc": 26088, "s": 108, "a": 160, "x": 117, "y": 104, "p": 45, "ram": [ [30, 225], [147, 188], [148, 211], [26086, 97], [26087, 30], [26088, 73], [54204, 79]]}, "cycles": [ [26086, 97, "read"], [26087, 30, "read"], [30, 225, "read"], [147, 188, "read"], [148, 211, "read"], [54204, 79, "read"]] }"#)]
#[case(r#"{ "name": "61 8b 47", "initial": { "pc": 8970, "s": 138, "a": 190, "x": 116, "y": 121, "p": 169, "ram": [ [8970, 97], [8971, 139], [8972, 71], [139, 215], [255, 241], [0, 87], [22513, 19]]}, "final": { "pc": 8972, "s": 138, "a": 56, "x": 116, "y": 121, "p": 169, "ram": [ [0, 87], [139, 215], [255, 241], [8970, 97], [8971, 139], [8972, 71], [22513, 19]]}, "cycles": [ [8970, 97, "read"], [8971, 139, "read"], [139, 215, "read"], [255, 241, "read"], [0, 87, "read"], [22513, 19, "read"]] }"#)]
#[case(r#"{ "name": "b4 e9 4b", "initial": { "pc": 39850, "s": 107, "a": 12, "x": 102, "y": 180, "p": 111, "ram": [ [39850, 180], [39851, 233], [39852, 75], [233, 245], [79, 6]]}, "final": { "pc": 39852, "s": 107, "a": 12, "x": 102, "y": 6, "p": 109, "ram": [ [79, 6], [233, 245], [39850, 180], [39851, 233], [39852, 75]]}, "cycles": [ [39850, 180, "read"], [39851, 233, "read"], [233, 245, "read"], [79, 6, "read"]] }"#)]
#[case(r#"{ "name": "28 c6 97", "initial": { "pc": 42290, "s": 163, "a": 158, "x": 119, "y": 110, "p": 173, "ram": [ [42290, 40], [42291, 198], [42292, 151], [419, 48], [420, 148]]}, "final": { "pc": 42291, "s": 164, "a": 158, "x": 119, "y": 110, "p": 164, "ram": [ [419, 48], [420, 148], [42290, 40], [42291, 198], [42292, 151]]}, "cycles": [ [42290, 40, "read"], [42291, 198, "read"], [419, 48, "read"], [420, 148, "read"]] }"#)]
#[case(r#"{ "name": "2c 9a d2", "initial": { "pc": 12224, "s": 248, "a": 82, "x": 91, "y": 31, "p": 164, "ram": [ [12224, 44], [12225, 154], [12226, 210], [53914, 174], [12227, 93]]}, "final": { "pc": 12227, "s": 248, "a": 82, "x": 91, "y": 31, "p": 164, "ram": [ [12224, 44], [12225, 154], [12226, 210], [12227, 93], [53914, 174]]}, "cycles": [ [12224, 44, "read"], [12225, 154, "read"], [12226, 210, "read"], [53914, 174, "read"]] }"#)]
#[case(r#"{ "name": "e9 c4 08", "initial": { "pc": 132, "s": 38, "a": 156, "x": 114, "y": 204, "p": 109, "ram": [ [132, 233], [133, 196], [134, 8]]}, "final": { "pc": 134, "s": 38, "a": 120, "x": 114, "y": 204, "p": 172, "ram": [ [132, 233], [133, 196], [134, 8]]}, "cycles": [ [132, 233, "read"], [133, 196, "read"]] }"#)]
#[case(r#"{ "name": "e9 cc bc", "initial": { "pc": 17267, "s": 167, "a": 80, "x": 48, "y": 153, "p": 234, "ram": [ [17267, 233], [17268, 204], [17269, 188]]}, "final": { "pc": 17269, "s": 167, "a": 45, "x": 48, "y": 153, "p": 232, "ram": [ [17267, 233], [17268, 204], [17269, 188]]}, "cycles": [ [17267, 233, "read"], [17268, 204, "read"]] }"#)]
#[case(r#"{ "name": "e9 55 57", "initial": { "pc": 65534, "s": 85, "a": 181, "x": 80, "y": 143, "p": 175, "ram": [ [65534, 233], [65535, 85], [0, 87]]}, "final": { "pc": 0, "s": 85, "a": 96, "x": 80, "y": 143, "p": 109, "ram": [ [0, 87], [65534, 233], [65535, 85]]}, "cycles": [ [65534, 233, "read"], [65535, 85, "read"]] }"#)]
#[case(r#"{ "name": "ed 3a 59", "initial": { "pc": 65535, "s": 63, "a": 15, "x": 67, "y": 16, "p": 35, "ram": [ [65535, 237], [0, 58], [1, 89], [22842, 26], [2, 221]]}, "final": { "pc": 2, "s": 63, "a": 245, "x": 67, "y": 16, "p": 160, "ram": [ [0, 58], [1, 89], [2, 221], [22842, 26], [65535, 237]]}, "cycles": [ [65535, 237, "read"], [0, 58, "read"], [1, 89, "read"], [22842, 26, "read"]] }"#)]
#[case(r#"{ "name": "f1 ff 74", "initial": { "pc": 2285, "s": 111, "a": 154, "x": 110, "y": 44, "p": 165, "ram": [ [2285, 241], [2286, 255], [2287, 116], [255, 33], [0, 116], [29773, 186]]}, "final": { "pc": 2287, "s": 111, "a": 224, "x": 110, "y": 44, "p": 164, "ram": [ [0, 116], [255, 33], [2285, 241], [2286, 255], [2287, 116], [29773, 186]]}, "cycles": [ [2285, 241, "read"], [2286, 255, "read"], [255, 33, "read"], [0, 116, "read"], [29773, 186, "read"]] }"#)]
#[case(r#"{ "name": "c9 bb bf", "initial": { "pc": 23436, "s": 182, "a": 16, "x": 242, "y": 19, "p": 175, "ram": [ [23436, 201], [23437, 187], [23438, 191]]}, "final": { "pc": 23438, "s": 182, "a": 16, "x": 242, "y": 19, "p": 44, "ram": [ [23436, 201], [23437, 187], [23438, 191]]}, "cycles": [ [23436, 201, "read"], [23437, 187, "read"]] }"#)]
#[case(r#"{ "name": "71 d9 3a", "initial": { "pc": 58319, "s": 21, "a": 227, "x": 79, "y": 175, "p": 40, "ram": [ [58319, 113], [58320, 217], [58321, 58], [217, 244], [218, 252], [64675, 139], [64931, 183]]}, "final": { "pc": 58321, "s": 21, "a": 0, "x": 79, "y": 175, "p": 169, "ram": [ [217, 244], [218, 252], [58319, 113], [58320, 217], [58321, 58], [64675, 139], [64931, 183]]}, "cycles": [ [58319, 113, "read"], [58320, 217, "read"], [217, 244, "read"], [218, 252, "read"], [64675, 139, "read"], [64931, 183, "read"]] }"#)]
#[case(r#"{ "name": "91 ff 49", "initial": { "pc": 20085, "s": 79, "a": 63, "x": 167, "y": 250, "p": 39, "ram": [ [20085, 145], [20086, 255], [20087, 73], [255, 213], [0, 110], [28367, 110]]}, "final": { "pc": 20087, "s": 79, "a": 63, "x": 167, "y": 250, "p": 39, "ram": [ [0, 110], [255, 213], [20085, 145], [20086, 255], [20087, 73], [28367, 110], [28623, 63]]}, "cycles": [ [20085, 145, "read"], [20086, 255, "read"], [255, 213, "read"], [0, 110, "read"], [28367, 110, "read"], [28623, 63, "write"]] }"#)]
#[case(r#"{ "name": "6c ff 70", "initial": { "pc": 10375, "s": 71, "a": 35, "x": 102, "y": 178, "p": 36, "ram": [ [10375, 108], [10376, 255], [10377, 112], [28927, 157], [28672, 152], [39069, 35]]}, "final": { "pc": 39069, "s": 71, "a": 35, "x": 102, "y": 178, "p": 36, "ram": [ [10375, 108], [10376, 255], [10377, 112], [28672, 152], [28927, 157], [39069, 35]]}, "cycles": [ [10375, 108, "read"], [10376, 255, "read"], [10377, 112, "read"], [28927, 157, "read"], [28672, 152, "read"]] }"#)]
#[case(r#"{ "name": "81 69 d3", "initial": { "pc": 6734, "s": 122, "a": 224, "x": 150, "y": 177, "p": 99, "ram": [ [6734, 129], [6735, 105], [6736, 211], [105, 149], [255, 152], [0, 51]]}, "final": { "pc": 6736, "s": 122, "a": 224, "x": 150, "y": 177, "p": 99, "ram": [ [0, 51], [105, 149], [255, 152], [6734, 129], [6735, 105], [6736, 211], [13208, 224]]}, "cycles": [ [6734, 129, "read"], [6735, 105, "read"], [105, 149, "read"], [255, 152, "read"], [0, 51, "read"], [13208, 224, "write"]] }"#)]
#[case(r#"{ "name": "20 55 13", "initial": { "pc": 379, "s": 125, "a": 158, "x": 137, "y": 52, "p": 230, "ram": [ [379, 32], [380, 85], [381, 19], [341, 173]]}, "final": { "pc": 341, "s": 123, "a": 158, "x": 137, "y": 52, "p": 230, "ram": [ [341, 173], [379, 32], [380, 125], [381, 1]]}, "cycles": [ [379, 32, "read"], [380, 85, "read"], [381, 19, "read"], [381, 1, "write"], [380, 125, "write"], [381, 1, "read"]] }"#)]
fn basics(#[case] json: &str) -> Result<()> {
    let scenario = Scenario::from_json(json)?;
    let (result, final_state) = run_scenario(&scenario);
    if !result {
        println!("{scenario}");
        if let Some(final_state) = final_state {
            println!("Actual:\n{final_state}");
        } else {
            println!("Actual: (not available)");
        }
    }
    assert!(result);
    Ok(())
}
